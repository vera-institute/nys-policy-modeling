# =============================================================================
# Program Author: Jaeok Kim
# Start Date: Dec 10, 2020
# Update Date: Feb 9, 2021
# Content: Policy Modeling
# Notes: Prison Modeling
# =============================================================================

* START ORG/ESS/LaTeX SESSION
#+begin_src emacs-lisp :results silent
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((R . t)
     (latex . t)
     (python . t)
     (shell . t)))
#+end_src
** Set org-mode confirmation of evaluation nil (Turn Off)
#+begin_src emacs-lisp :results silent
  ;; DANGER!
  ;; Do not Use Unless You Really, Really Mean It
  (setq org-confirm-babel-evaluate nil)
#+end_src

** Set org-mode confirmation of evaluation TRUE (Turn On)
#+begin_src emacs-lisp :results silent
  (setq org-confirm-babel-evaluate t)
#+end_src


* Load Package  ---------------------------------------------------------------------------
#+begin_src R :session :results silent

# .libPaths(c("/Documents/R",.libPaths()))


library(aws.s3)
library(reshape2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(janitor)
library(scales)
library(openxlsx)
library(tibble)
library(foreign)
library(plyr)
library(stringr)
library(dtplyr)
library(data.table)
library(ggplot2)
library(Hmisc)
library(psych)
library(eeptools)
library(zoo)
library(ggrepel)
library(devtools)
library(ggpubr)
library(readxl)


# options(scipen=999)

#+end_src


* Setup Path and Read-in Data --------------------------------------------------------------
#+begin_src R :session :results silent

setwd("~/OneDrive - Vera Institute of Justice/GitHub/policy-modeling")

# LOAD ORIGINAL DATA FROM S3

## Snapshot 2020-02-14
## "2020_02_14_DOCCS_current_clean.csv"

df.current <- s3read_using(FUN=read.csv,
                   object="2020_02_14_DOCCS_current_clean.csv",
		   bucket="vera-gjny/curated_data/ny_prison/in_custody/2020_02")

df.current <- df.current %>%
   mutate(id= seq(1, nrow(.), by=1))

## Clean Snapshot 2020-02-14
ds <- readRDS("data/doccs.clean.2020.02.14.rds")

## clean variable
ds <- ds %>%
   mutate(age.current.group2=ifelse(age.current>=55, "age55+", "Under55"),
          race.group=ifelse(is.na(race.eth), "Other/Unknown",
                     ifelse(race.eth=="Other", "Other/Unknown", race.eth)),
          max.sent.group=ifelse(max.sent.yr<10 , "Less than 10yrs",
                         ifelse(max.sent.yr>=10 & max.sent.yr<150, "10yrs or longer",
			 ifelse(max.sent.yr==9999, "Life", NA))))


## 2018 Data
doccs2018 <- read.csv("data/DOCCSJan2018.csv")

## 2020 October
## "2020_10_01_DOCCS_current_clean.csv"

df.oct <- s3read_using(FUN=read.csv,
                   object="2020_10_01_DOCCS_current_clean.csv",
		   bucket="vera-gjny/curated_data/ny_prison/in_custody/2020_10")


## People In Custody (NYS Open Data)
custody <- read.csv("~/OneDrive - Vera Institute of Justice/Project/ESI/Modeling/Data/Inmates_Under_Custody__Beginning_2008.csv")


#+end_src


* Projecting Future Population accounting for stock and flow
#+begin_src R :session :results silent

# In Custody Population Data
custody <- read.csv("data/Inmates_Under_Custody__Beginning_2008.csv")
custody <- custody %>%
   dplyr::rename(
      year=Snapshot.Year,
      adm.type=Latest.Admission.Type,
      county=County.of.Indictment,
      gender=Gender,
      top.crime=Most.Serious.Crime,
      age=Current.Age,
      facility=Housing.Facility,
      security.level=Facility.Security.Level,
      race=Race.Ethnicity) %>%
   mutate(type="total") %>%
   select(year, type, adm.type, county, age, gender, top.crime)

# Yearly Admission Data
admission <- read.csv("data/Prison_Admissions__Beginning_2008.csv")
admission <- admission %>%
   dplyr::rename(
     adm.year=Admission.Year,
     adm.mo=Month.Code,
     adm.type=Admission.Type,
     county=County.of.Commitment,
     residence=Last.Known.Residence.County,
     gender=Gender,
     age=Age.at.Admission,
     top.crime=Most.Serious.Crime) %>%
   mutate(
      type="admission",
      year=ifelse(adm.mo<=3, adm.year, adm.year+1)) %>%
   select(year, type, adm.type, county, age, gender, top.crime)

# Bind In-custody Data and Yearly Admission Data
## NOTE: Admission Data Missing Feb2019-Mar2020 Admission

sf <- bind_rows(admission, custody) %>%
   mutate(
      age.group=ifelse(age<18, "Under 18",
                ifelse(age>=18 & age<21, "age18-20",
		ifelse(age>=21 & age<25, "age21-24",
		ifelse(age>=25 & age<30, "age25-29",
		ifelse(age>=30 & age<35, "age30-34",
		ifelse(age>=35 & age<40, "age35-39",
		ifelse(age>=40 & age<45, "age40-44",
		ifelse(age>=45 & age<50, "age45-49",
		ifelse(age>=50 & age<55, "age50-54",
		ifelse(age>=55 & age<60, "age55-59",
		ifelse(age>=60, "60 or over", NA))))))))))),
      age.group=factor(age.group,
                       levels=c("Under 18", "age18-20", "age21-24", "age25-29",
           	             "age30-34", "age35-39", "age40-44", "age45-49",
			     "age50-54", "age55-59", "60 or over")),
      age.group2=ifelse(age>=55, "age55+", "Under55"),
      NYC=ifelse(county %in% c("KINGS", "QUEENS", "NEW YORK", "BRONX", "RICHMOND"), "NYC", "non-NYC"))

# Charge Severity Clean

crime.code <- read_excel("data/DOCCS_Crime_Codes_DCJS.xlsx")
crime.code <- data.frame(crime.code)
names(crime.code) <- c("doccs.code", "crime.desc", "effective.date", "repeal.date", "legal",
                       "code", "class", "crime.type")


<- left_join(sf, crime.code) %>%






# PROJECTION (28 groups): Admission Type*Charge Severity/Age/NYC
## NOTE: Missing Admissions Jan2020-Mar2020 (impute the average admission of the last 9months)

var_list <- c("adm.type", "age.group2", "NYC", "type", "year")

## Create a lag variable
df.overall <- sf %>%
   filter(year>=2016) %>%
   group_by_at(var_list) %>%
   dplyr::summarise(N=n()) %>%
   mutate(N=ifelse(type=="admission" & year==2020, round(N+N*3/9), N)) %>%
   mutate(N.lag1=dplyr::lag(N, n=1, default=NA)) %>%
   arrange_at(var_list) %>% data.frame() %>%
   mutate(year=paste0("y",year),
	  delta=(N-N.lag1)/N.lag1)

## Create a weighted average of pouplation
df1 <- df.overall %>%
   select(-(N.lag1:delta)) %>%
   spread(key=year, value=N, fill=NA) %>%
   mutate(wAvg=(y2016*1+y2017*1+y2018*2+y2019*2+y2020*3)/9)

## Create a weighted average of yearly percent changes
df2 <- df.overall %>%
   select(-(N:N.lag1)) %>%
   spread(key=year, value=delta) %>%
   select(-y2016) %>%
   dplyr::rename(d1617=y2017,
                 d1718=y2018,
		 d1819=y2019,
		 d1920=y2020) %>%
   mutate(wDelta=tanh((d1617*1+d1718*2+d1819*2+d1920*3)/8*4))

#  Estimate 2030 baseline: Multiply two to project the 2030 baseline

var_merge <- var_list[which(var_list!="year")]

df3 <- df1 %>%
   left_join(df2, by=var_merge) %>%
   mutate(y2030=wAvg*(1+wDelta),
          d=(y2030-y2020)/10)


# Estimate population in 2021-2029: Linear interpolation bewteen 2020-2030

mylist <- list()

for (i in 1:10) {

   x <- df3$y2020+df3$d*i

   print(x)

   mylist[[i]] <-x

  print(mylist)
}

tmp <- do.call("rbind", mylist)
tmp <- t(tmp)
toMerge <- data.frame(tmp)

colnames(toMerge) <- paste0("y",seq(2021, 2030, by=1))
toMerge <- cbind(toMerge, df3[,var_merge])
toMerge <- toMerge[,-10]

# Merge files
proj <- df3 %>%
   left_join(toMerge, by=var_merge) %>%
   select(var_merge, y2016:y2020, y2021:y2029, y2030) %>%
   mutate_at(vars(y2021:y2030), function(x) (round(x)))


## EXPORT DATA POINTS FOR A Figure
write.csv(proj, "data/proj12.csv")

# Aggregate numbers
agg.proj <- proj %>%
group_by(type) %>%
summarise_at(vars(y2016:y2030), funs(sum)) %>% data.frame()

## EXPORT DATA POINTS FOR A Figure
write.csv(agg.proj, "data/agg.proj12.csv")

# Aggregate numbers
proj %>%
group_by(type,adm.type) %>%
summarise_at(vars(y2016:y2030), funs(sum)) %>% data.frame()


#+end_src


* Prospective Impact Estimation ------------------------------------------------------------
** Parole Reform Impact Estimation
#+begin_src R :session :results silent

## CONDITION MATRIX (To Create)  ++ WORKING +++

AE2 <- 55 # P2_Elder Parole_Age at Eligible : 50, (55), 60, 65
TS2 <- 15 # P2_Elder Parole_Time Served: 5, 10, (15), 20
TS5 <- 10 # P5_Youth Parole_Time Served: 5, (10), 15, 20
AC5 <- 25 # P5_Youth Parole_Age at Crime (Under): 21, (25)
TS4 <- 10 # P4_Retroactive Sentencing: 5, (10), 15, 20, 25

## Baseline release rate parameters without fair and timely parole
prob.base <- c(0.70, 0.27, 0.03)
group <- c("board", "CR", "NoRelease")
pct.TS.base.board <- 0.53 # baseline avg.% maximum sentence served for those who were released by the parole board

addTime <- ifelse(pct.TS.base.board==0.53, 0.2,
           ifelse(pct.TS.base.board==0.40, 0.15,
	   ifelse(pct.TS.base.board==0.30, 0.11,
	   ifelse(pct.TS.base.board==0.20, 0.075,
	   ifelse(pct.TS.base.board==0.10, 0.038,
	   ifelse(pct.TS.base.board==0, 0))))))

# Additional Time Served after eligible for parole
# 0.20, 0.15, 0.11, 0.075,  0.038, 0
# 0.53, 0.40, 0.30, 0.20,  0.10, 0 (corresponding % maximum sentence served)

## Release Rate Parameters for Fair and Timely Parole
prob <- c(0.70, 0.27, 0.03) # Distribution of release by parole board, release on conditional release date, no release until maximum
## (0.85, 0.135, 0.015)
## (1, 0, 0)
## group <- c("board", "CR", "NoRelease")

pct.TS3.board = 0.0  # [0.53 .40 .30 .20 .10 (.0)] # Release by the parole board: Percent maximum sentence served

addTime.p3 <- ifelse(pct.TS3.board==0.53, 0.2,
              ifelse(pct.TS3.board==0.40, 0.15,
	      ifelse(pct.TS3.board==0.30, 0.11,
	      ifelse(pct.TS3.board==0.20, 0.075,
	      ifelse(pct.TS3.board==0.10, 0.038,
	      ifelse(pct.TS3.board==0, 0))))))

age.life <- 75

## Create Charge Exclusion Criteri
## Retroactive sentencing
pl125 <- unique(ds$charge1[which(str_detect(ds$charge1, "(HOMICIDE|MANSLAUGH|MURDER)"))])
money.laundering.terror <-
   unique(ds$charge1[str_detect(ds$charge1, "MONEY") & str_detect(ds$charge1, "TERROR")])
pl130 <- unique(ds$charge1[which(str_detect(ds$charge1, "(SEXUAL|RAPE)"))])

pl263 <- unique(ds$charge1[which(str_detect(ds$charge1, "CHILD") &
                                 str_detect(ds$charge1, "SEX"))])

exclusion.list <- c(pl125, pl130, pl263, money.laundering.terror)

## Eligibility Flag by Policy

wd  <- ds %>%
   mutate(
     # P1: TPV
      p1.elig=ifelse(adm.type=="Parole/Cond.Rel Revoc",1,0), # identify people admitted for parole violation
      p1.elig.yr=ifelse(p1.elig==1 & year(date.adm)<2021, 2021, NA), # people who are already eleigible on Jan1,2021

     # P2: Elder Parole
      date.age.c=as.Date(DOB+AE2*365), # date when age c (e.g.55)
      date.served.c=as.Date(date.adm+TS2*365), # date when served c (e.g.15) yrs
      date.elig2=as.Date(ifelse(date.age.c>date.served.c, date.age.c, date.served.c)), # earlest date meeting both criteria

      p2.elig=ifelse(adm.type!="New Commitment", 0, # exclude anyone not serving a sentence on commitment crime
              ifelse(!is.na(par.elig.date) & (year(date.elig2)-year(par.elig.date))<0, 1, # available for earlier parole (indeterminate sentences)
              ifelse(is.na(par.elig.date) & (year(date.elig2)-year(max.exp.date))<0, 1, 0))), # available for parole (determinate sentences)
      p2.elig.yr=ifelse(p2.elig==1 & year(date.elig2)<2021, 2021,
                 ifelse(p2.elig==1, year(date.elig2), NA)),
      date.elig2=ifelse(p2.elig==1 & year(date.elig2)<2021, ymd("2021-01-01"), date.elig2),
      date.elig2=as.Date(date.elig2, format="%Y-%m-%d"),

     # P5: Youth Parole
      date.elig5=as.Date(sent.date+TS5*365), # date when served c (e.g. 10) yrs; date eligible for parole
      youth=ifelse(age.crime<AC5, 1, 0), # people who committmed crime before age c (e.g.25)
      p5.elig=ifelse(adm.type!="New Commitment", 0,
                ifelse(youth==1 & date.elig5<par.elig.date,1, 0)), # people who meet both criteria (age at crime and sentence length)
      p5.elig.yr=ifelse(p5.elig==1 & year(date.elig5)<2021, 2021,
                 ifelse(p5.elig==1, year(date.elig5), NA)),
      date.elig5=ifelse(p5.elig==1 & year(date.elig5)<2021, ymd("2021-01-01"), date.elig5),
      date.elig5=as.Date(date.elig5, format="%Y-%m-%d"),

     # P3: Fair and Timely Parole
      date.elig3=ifelse(adm.type=="New Commitment" & str_detect(sent.type, "Indeterminate"), par.elig.date, NA),
      date.elig3= as.Date(date.elig3, format="%Y-%m-%d"),
      p3.elig=ifelse(adm.type!="New Commitment", 0, # Exclude anyone not serving a sentence
              ifelse(str_detect(sent.type, "Indeterminate") & !is.na(date.elig3), 1,
              0)),
      p3.elig.yr=ifelse(p3.elig==1 & year(date.elig3)>=2021, year(date.elig3),
                 ifelse(p3.elig==1 & year(date.elig3)<2021, 2021, NA)),
      date.elig3=ifelse(p3.elig==1 & year(date.elig3)<2021, ymd("2021-01-01"), date.elig3),
      date.elig3=as.Date(date.elig3, format="%Y-%m-%d"),

      # P4: Retroactive Sentencing
      sent.c=ifelse(max.sent.yr>=TS4, 1,0),    # Sentenced longer than c years (e.g.10)
      date.served.third=as.Date(sent.date+days(round(agg.max.sent/3)), format="%Y-%d-%d"), # date when served 1/3 max sentence
      p4.elig=ifelse(adm.type!="New Commitment", 0, # Exclude anyone not serving a new sentence
              ifelse(charge1 %in% exclusion.list, 0, # Charge Exclusion
	      ifelse(sent.c==1 & date.served.third<cond.rel.date-years(2), 1,
	      ifelse(sent.c==1 & is.na(cond.rel.date) & date.served.third<max.exp.date-years(2),1,
                     0)))),
      date.elig4=ifelse(p4.elig==1, date.served.third, NA),
      date.elig4=as.Date(date.elig4, format="%Y-%m-%d"),
      p4.elig.yr=ifelse(p4.elig==1 & year(date.elig4)<2021, 2021,
                 ifelse(p4.elig==1, year(date.elig4), NA)),
      date.elig4=ifelse(p4.elig==1 & year(date.elig4)<2021, ymd("2021-01-01"), date.elig4),
      date.elig4=as.Date(date.elig4, format="%Y-%m-%d"))


## Estimate Release Date Under Policy Reform Scenario
set.seed(4634)

wd2 <- wd %>%
   mutate(
      date.age.life=as.Date(DOB+age.life*365, format="%Y-%m-%f"), # date when age X (life expectancy)
      new.max.exp.date=ifelse(max.sent.group=="Life", date.age.life, max.exp.date),
      new.max.exp.date=as.Date(new.max.exp.date, origin="1970-01-01"),

     # P1: TPV
      p1.date.adm=ifelse(p1.elig==1 & year(date.adm)>=2021, NA, date.adm),
      p1.date.rel=ifelse(p1.elig==1 & year(date.adm)>=2021, NA,
                  ifelse(p1.elig==1 & year(date.adm)<2021,
                         as.Date("2021-01-01", format="%Y-%m-%d"), NA)),
      p1.date.adm=as.Date(p1.date.adm, format="%Y-%m-%d"),
      p1.date.rel=as.Date(p1.date.rel, format="%Y-%m-%d"),

     # P2: Elder Parole
      p2.rel.group = ifelse(p2.elig==1,
                            sample(group, size=n(), prob=prob.base, replace=TRUE), NA),
      p2.date.adm = date.adm,
      p2.date.rel = ifelse(p2.rel.group=="board", date.elig2+(max.exp.date-date.elig2)*addTime,
                    ifelse(p2.rel.group=="CR", cond.rel.date,
                    ifelse(p2.rel.group=="NoRelease", new.max.exp.date, NA))),
#      p2.date.rel = ifelse(p2.elig==1 & year(as.Date(p2.date.rel,format="%Y-%m-%d"))<2021, 2021, p2.date.rel),

     # P5: Youth Parole
      p5.rel.group = ifelse(p5.elig==1,
                            sample(group, size=n(), prob=prob.base, replace=TRUE), NA),
      p5.date.adm = date.adm,
      p5.date.rel = ifelse(p5.rel.group=="board", date.elig5+(max.exp.date-date.elig5)*addTime,
                    ifelse(p5.rel.group=="CR", cond.rel.date,
                    ifelse(p5.rel.group=="NoRelease", new.max.exp.date, NA))),
#      p5.date.rel = ifelse(p5.elig==1 & year(as.Date(p5.date.rel,format="%Y-%m-%d"))<2021, 2021, p5.date.rel),

     # P3: Fair and Timely Parole
      p3.rel.group = ifelse(p3.elig==1,
                            sample(group, size=n(), prob=prob, replace=TRUE), NA),
      p3.date.adm = date.adm,
      p3.date.rel = ifelse(p3.rel.group=="board", date.elig3+(max.exp.date-date.elig3)*addTime.p3,
                    ifelse(p3.rel.group=="CR", cond.rel.date,
                    ifelse(p3.rel.group=="NoRelease", new.max.exp.date, NA))),
      p3.date.rel=as.Date(p3.date.rel,format="%Y-%m-%d"),

     # P4: Retroactive Sentencing
      p4.rel.group = ifelse(p4.elig==1,
                            sample(group, size=n(), prob=prob.base, replace=TRUE), NA),
      p4.date.adm = date.adm,
      p4.date.rel = ifelse(p4.rel.group=="board", date.elig4+(max.exp.date-date.elig4)*addTime,
                    ifelse(p4.rel.group=="CR", cond.rel.date,
                    ifelse(p4.rel.group=="NoRelease", new.max.exp.date, NA))),
      p4.date.rel = ifelse(p4.elig==1 & year(as.Date(p4.date.rel,format="%Y-%m-%d"))<2021, 2021, p4.date.rel))%>%
   mutate_at(vars(ends_with("date.rel")), funs(as.Date(., format="%Y-%m-%d"))) %>%
   mutate_at(vars(ends_with("date.rel")), funs("yr"=year(.))) %>%
   rename_with(., ~gsub("date.rel_yr", "rel.yr", .x, fixed=TRUE),  ends_with("date.rel_yr")) %>%
   select(ends_with("rel.yr") | ends_with(".elig"))




## BETA
## Estimate Release Date Under Policy Reform Scenario
set.seed(4634)

wd2 <- wd %>%
   mutate(
     date.age.life=as.Date(DOB+age.life*365, format="%Y-%m-%f"), # date when age X (life expectancy)
     # P1: TPV
      p1.date.adm=ifelse(p1.elig==1 & year(date.adm)>=2021, NA, date.adm),
      p1.date.rel=ifelse(p1.elig==1 & year(date.adm)>=2021, NA,
                  ifelse(p1.elig==1 & year(date.adm)<2021,
                         as.Date("2021-01-01", format="%Y-%m-%d"), NA)),
      p1.date.adm=as.Date(p1.date.adm, format="%Y-%m-%d"),
      p1.date.rel=as.Date(p1.date.rel, format="%Y-%m-%d"),

     # P2: Elder Parole
      p2.rel.group = ifelse(p2.elig==1,
                            sample(group, size=n(), prob=prob.base, replace=TRUE), NA),
      p2.date.adm = date.adm,
      pct.TS.p2 = ifelse(p2.rel.group=="board", pct.base.board,
                    ifelse(p2.rel.group=="CR", pct.base.CR,
                    ifelse(p2.rel.group=="NoRelease", 1, NA))),
      new.max.sent.p2=ifelse(max.sent.group=="Life", agg.min.sent+(date.age.life-date.elig2),
                          agg.max.sent),
      p3.date.rel=ifelse(p2.elig==1 & p2.rel.group=="NoRelease", date.age.life,
                  ifelse(p2.elig==1, date.elig2+round(pct.TS.p2*new.max.sent.p2-agg.min.sent,0),NA)),
      p3.date.rel=as.Date(p3.date.rel, origin="1970-01-01"),
      ## (agg.min.sent+(proj.rel.date-elig.date)/agg.max.sent= pct.time.served
      p3.date.rel=as.Date(p3.date.rel,format="%Y-%m-%d"),
      p2.date.rel = ifelse(p2.elig==1 & year(as.Date(p2.date.rel,format="%Y-%m-%d"))<2021, 2021, p2.date.rel),

     # P5: Youth Parole
      p5.rel.group = ifelse(p5.elig==1,
                            sample(group, size=n(), prob=prob.base, replace=TRUE), NA),
      p5.date.adm = date.adm,

      p5.date.rel = ifelse(p5.rel.group=="board", date.elig5+(max.exp.date-date.elig5)*addTime,
                    ifelse(p5.rel.group=="CR", cond.rel.date,
                    ifelse(p5.rel.group=="NoRel", max.exp.date, NA))),
      p5.date.rel = ifelse(p5.elig==1 & year(as.Date(p5.date.rel,format="%Y-%m-%d"))<2021, 2021, p5.date.rel),

     # P3: Fair and Timely Parole
      p3.rel.group = ifelse(p3.elig==1,
                            sample(group, size=n(), prob=prob, replace=TRUE), NA),
      p3.date.adm = date.adm,
      pct.TS3.p3 = ifelse(p3.rel.group=="board", pct.TS3.board,
                   ifelse(p3.rel.group=="CR", pct.TS3.CR,
	       	   ifelse(p3.rel.group=="NoRelease", 1, NA))),
      new.max.sent.p3=ifelse(max.sent.group=="Life", agg.min.sent+(date.age.life-date.elig3),
                          agg.max.sent),
      p3.date.rel=ifelse(p3.elig==1 & p3.rel.group=="NoRelease", date.age.life,
                  ifelse(p3.elig==1, date.elig3+round(pct.TS3.p3*new.max.sent.p3-agg.min.sent,0),NA)),
      p3.date.rel=as.Date(p3.date.rel, origin="1970-01-01"),
      ## (agg.min.sent+(proj.rel.date-elig.date)/agg.max.sent= pct.time.served
      p3.date.rel=as.Date(p3.date.rel,format="%Y-%m-%d"),

     # P4: Retroactive Sentencing
      p4.rel.group = ifelse(p4.elig==1,
                            sample(group, size=n(), prob=prob, replace=TRUE), NA),
      p4.date.adm = date.adm,
      p4.date.rel = ifelse(p4.rel.group=="board", date.elig4+(max.exp.date-date.elig4)*addTime,
                    ifelse(p4.rel.group=="CR", cond.rel.date,
                    ifelse(p4.rel.group=="NoRel", max.exp.date, NA))),
      p4.date.rel = ifelse(p4.elig==1 & year(as.Date(p4.date.rel,format="%Y-%m-%d"))<2021, 2021, p4.date.rel))%>%
   mutate_at(vars(ends_with("date.rel")), funs(as.Date(., format="%Y-%m-%d"))) %>%
   mutate_at(vars(ends_with("date.rel")), funs("yr"=year(.))) %>%
   rename_with(., ~gsub("date.rel_yr", "rel.yr", .x, fixed=TRUE),  ends_with("date.rel_yr")) %>%
   select(ends_with("rel.yr") | ends_with(".elig"))

# filter(p3.rel.yr<2021)%>% head()












## Estimtate Release Date Under NO Policy Reform Scenario

# Sentence Type
wd %>% group_by(sent.type) %>% dplyr::summarise(Ntotal=n(),Nmiss=sum(is.na(max.exp.date)))


set.seed(4634)

age.life <- 75 # Life Expectancy

prob.less10 <- c(0.67, 0.33, 0)
group.less10 <- c("board.less10", "CR", "NoRel")

prob.over10 <- c(0.48, 0.39, 0.13)
group.over10 <- c("board.over10", "CR", "NoRel")

prob.life <- c(0.96, 0.04)
group.life <- c("board.life", "NoRel")

pct.max.less10 <- 0.47
pct.max.over10 <- 0.53
pct.max.life <- 0.52

wd %>%
   mutate(
      date.age.life=as.Date(DOB+age.life*365.25, format="%Y-%m-%f"), # date when age X (life expectancy)
      proj.rel.group=ifelse(sent.type=="Indeterminate-Not LIFE" & max.sent.group=="Less than 10yrs",
                            sample(group.less10, size=n(), prob.less10, replace=TRUE),
	             ifelse(sent.type=="Indeterminate-Not LIFE" & max.sent.group=="10yrs or longer",
                            sample(group.over10, size=n(), prob.over10, replace=TRUE),
	             ifelse(sent.type=="Indeterminate-LIFE",
                            sample(group.life, size=n(), prob.life, replace=TRUE), NA))),
      proj.rel.date=ifelse(proj.rel.group=="CR", cond.rel.date,
                    ifelse(proj.rel.group=="board.less10", sent.date+round(agg.max.sent*pct.max.less10),
                    ifelse(proj.rel.group=="board.over10", sent.date+round(agg.max.sent*pct.max.over10),
                    ifelse(proj.rel.group=="board.life", sent.date+(date.age.life-sent.date)*pct.max.life,
		    ifelse(proj.rel.group=="NoRel", date.age.life, NA))))),
      proj.rel.date=as.Date(proj.rel.date, format="%Y-%m-%d"),
      proj.rel.yr=year(proj.rel.date)) %>%
 select(proj.rel.yr) %>% table() %>% cumsum()





filter(str_detect(sent.type, "LIFE")) %>%
select(max.sent.group, date.age.life:proj.rel.yr) %>% head()

      p4.rel.group = ifelse(p4.elig==1,
                            sample(group, size=n(), prob=prob, replace=TRUE), NA),


                     ifelse(sent.type=="Indeterminate-LIFE", sample(group.life, prob.life, replace=TRUE),NA)),
      proj.rel.date=ifelse(sent.type=="Determinate", max.exp.date,
                    ifelse(sent.type=="LWOP", date.age.life,
                    ifelse(sent.type=="Inteterminate-LIFE",
                    ifelse(sent.type=="Indeterminate-Not LIFE", , NA)))),
      proj.rel.date=as.Date(proj.rel.date, format="%Y-%m-%d"))



      p5.rel.group = ifelse(p5.elig==1,
                            sample(group, size=n(), prob=prob, replace=TRUE), NA),
      p5.date.adm = date.adm,
      p5.date.rel = ifelse(p5.rel.group=="board", date.elig5+(max.exp.date-date.elig5)*addTime,
                    ifelse(p5.rel.group=="CR", cond.rel.date,
                    ifelse(p5.rel.group=="NoRel", max.exp.date, NA))),
      p5.date.rel = ifelse(p5.elig==1 & year(as.Date(p5.date.rel,format="%Y-%m-%d"))<2021, 2021, p5.date.rel),




# Aggregate numbers
 <-
proj %>%
group_by(type, adm.type) %>%
summarise_at(vars(y2016:y2030), funs(sum)) %>% data.frame()







## Estimate Number of Release by Year For Each Combinations of Policy Reform Scenario



# +++ START HERE ++++++++

tmp2 <- wd2 %>%
   group_by(p2.rel.yr) %>%
   dplyr:: summarise(p2.rel=sum(p2.elig, na.rm=TRUE)) %>%
   dplyr:: rename(rel.yr=p2.rel.yr) %>%
   filter(rel.yr<=2030) %>% data.frame()

tmp3 <- wd2 %>%
   group_by(p3.rel.yr) %>%
   dplyr:: summarise(p3.rel=sum(p3.elig, na.rm=TRUE)) %>%
   dplyr:: rename(rel.yr=p3.rel.yr) %>%
   filter(rel.yr<=2030) %>% data.frame()

tmp4 <- wd2 %>%
   group_by(p4.rel.yr) %>%
   dplyr:: summarise(p4.rel=sum(p4.elig, na.rm=TRUE)) %>%
   dplyr:: rename(rel.yr=p4.rel.yr) %>%
   filter(rel.yr<=2030) %>% data.frame()

tmp5 <- wd2 %>%
   group_by(p5.rel.yr) %>%
   dplyr:: summarise(p5.rel=sum(p5.elig, na.rm=TRUE)) %>%
   dplyr:: rename(rel.yr=p5.rel.yr) %>%
   filter(rel.yr<=2030) %>% data.frame()

#+end_src
